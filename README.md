# Music Wave
- Use wave generators to play music
- Currently only support WaveForms devices
- Tested on analog discovery 2

## ~~SCPI~~
For function generators supporting SCPI commands

## WaveForms
For Analog Discovery 2

### How to (Prototype)
1. Download [WaveForms SDK](https://store.digilentinc.com/waveforms-previously-waveforms-2015/)
1. Clone this repo
1. Get some [midi files!](https://musescore.com)
1. Go to repo directory and install required packages `pip install -r requirements.txt`
1. `cd WaveForms/`
1. `python WaveForms/main.py DIR_TO_MIDI_FILES`

## TODO
1. [ ] Package design / Directory Structure
	- Make this a package
	- WaveMusician 
		- resources
			- MIDI Files
			- MusicXML Files
			- MP3 Files
			- Other music format
		- src
			- Loader
				- Abstract Loader
				- MIDI File Loader
				- MusicXML Loader
				- MP3 Loader
				- KeyboardInput Loader
					- Play from keyboard
			- WaveGenerator 
				- Abstract WaveGenerator
					- Unified interface for wave generator
					- Modify output instrument style
				- (Different kinds of wave generator that implement the api interface, i.e. transform loader info into generator commands)
				- SCPI Devices
				- WaveForms
				- Other wave generator
		- examples
			- Sample code
		- setup.py
		- and other package installation files
1. [ ] Unified note message data structure design
	1. Track message for wave generator
		1. Wave Channel
		1. Wave Function
			1. Wave data, for custom wave
		1. Wave Amplitude
		1. Wave Frequency
		1. Wave Phase
		1. Wave Offset
1. [ ] Multiple Notes Support
	1. Too many notes overlap 
	1. Preprocess input track? to calculate custom waves
	1. Real-time solution
		1. Create a superimposer class
			1. Add note => add a mathematical function
		1. Superposition using custom wave function
			1. Set the frequency of the generator to an ideal initial value `f_0`
			1. Map the note function with frequency `f_s` into one period of the wave of initial frequency setting `f_0` 
				1. T_s: period time for note, in seconds; T_0: period time for initial frequency f_0, in seconds
				1. Ideally, we want to find `f_0` such that for a positive integer `K`, `K * T_s = T_0`, which allows the wave generator to perfectly include the note function in `T_0` 
				1. `K * T_s = T_0` <=> `K/f_s = 1/f_0`
				1. To comparison choices of `f_0`, we can use the following formula: `discrepancy = f_s/f_0 - floor(f_s/f_0)`, in which `discrepancy` is the decimal portion of `f_s/f_0` or `K`. The closer `discrepancy` is to `0.5`, the more inconsistent the generated wave is.
			1. Use numpy to calculate the wave on `[0, T_0]` and perform any superposition if required
			1. Send superimposed wave in numerical array to wave generator
				1. Note that the choice of `f_0` will affect the overall quality of sound output as the buffer size is limited (4096 samples for AD2)
				1. Therefore, with smaller `f_0`, although the less discrepancy the note wave will be, the less smooth the generated wave will be as the period increase whlie the device buffer size is unchanged.
				1. Opposite situation for choosing larger `f_0`
			1. Solve Phase issue
				1. How to add phase into the noteData
				1. How to remove the wave function with phase from noteData
			1. **Noise Control**
				1. Too much noise in the arrary generated by numpy
		1. Note
			1. For WaveForm SDK: The frequency of the generated waveform: repetition frequency for standard types and custom data; DAC update for noise type; sample rate for play type.
1. [ ] Noise Canclling
	1. Uncertainty in float and numpy math function
	1. Created noise in wave data
1. [ ] Instrument Style
	1. Generate waves similar to instrument indicated in music files
		1. Use predefined waves data
1. [ ] Better Command Line Tools
	1. Configuration
	1. File dir
1. [ ] MIDI Other control message implementation
	1. [ ] Sustain Pedal 

## info
- WaveForms
	- [Python API Wrapper](https://github.com/amuramatsu/dwf)
	- [WaveForms SDK Reference Manual](https://s3-us-west-2.amazonaws.com/digilent/resources/instrumentation/waveforms/waveforms_sdk_rm.pdf)
	- [WaveForms Reference Website](https://reference.digilentinc.com/reference/software/waveforms/waveforms-3/startmu)
- MIDI Python
	- [Mido](https://mido.readthedocs.io/en/latest/message_types.html)
- MIDI Message & File Format 
	- [Message Summary](https://www.midi.org/specifications-old/item/table-1-summary-of-midi-message)
	- [Control Message](https://www.midi.org/specifications-old/item/table-3-control-change-messages-data-bytes-2)
	- [MIDI File Format](https://www.csie.ntu.edu.tw/~r92092/ref/midi/)